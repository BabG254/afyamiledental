# Enable mod_rewrite
RewriteEngine On

# ================================================================
# CANONICAL DOMAIN REDIRECTS - Fix WWW vs non-WWW issues
# ================================================================

# Force HTTPS and non-WWW canonical domain (https://afyamiledental.com)
# This fixes both "Page with redirect" and "Alternate page with proper canonical tag" issues
RewriteCond %{HTTPS} !=on [OR]
RewriteCond %{HTTP_HOST} ^www\. [NC]
RewriteRule ^(.*)$ https://afyamiledental.com/$1 [R=301,L]

# ================================================================
# URL NORMALIZATION - Fix redirect issues
# ================================================================

# Redirect index.html to root (clean URLs)
RewriteCond %{THE_REQUEST} \s/+index\.html[\s?] [NC]
RewriteRule ^index\.html$ https://afyamiledental.com/ [R=301,L]

# Handle www.afyamiledental.com/index.html specifically
RewriteCond %{THE_REQUEST} \s/+index\.html[\s?] [NC]
RewriteCond %{HTTP_HOST} ^www\. [NC]
RewriteRule ^index\.html$ https://afyamiledental.com/ [R=301,L]

# Remove trailing slashes from files (but not directories)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} /+$
RewriteRule ^(.*)/ https://afyamiledental.com/$1 [R=301,L]

# Add trailing slash to directories (ensure consistency)
RewriteCond %{REQUEST_FILENAME} -d
RewriteCond %{REQUEST_URI} !/$
RewriteRule ^(.*)$ https://afyamiledental.com/$1/ [R=301,L]

# Enable GZIP compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Set cache expiration headers
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ================================================================
# ERROR HANDLING - Better SEO with proper error pages
# ================================================================

# Custom error pages (redirect to home for better user experience and SEO)
ErrorDocument 404 /index.html
ErrorDocument 403 /index.html
ErrorDocument 500 /index.html

# ================================================================
# SECURITY AND FILE PROTECTION
# ================================================================

# Prevent directory browsing
Options -Indexes

# Protect sensitive files
<FilesMatch "(^#.*#|\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])|~)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Make sure sitemap.xml and robots.txt are accessible for search engines
<Files "sitemap.xml">
    Order Allow,Deny
    Allow from all
</Files>

<Files "robots.txt">
    Order Allow,Deny
    Allow from all
</Files>
